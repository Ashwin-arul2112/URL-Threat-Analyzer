{% extends "layout.html" %}
{% block content %}

<div class="dashboard-container fade-in">
  <h1 class="title">URL Threat Intelligence Dashboard</h1>

  <!-- Statistic Cards -->
  <div class="cards">
    <div class="card total">
      <h2>Total Scans</h2>
      <p id="totalCount">{{ total }}</p>
    </div>
    <div class="card safe">
      <h2>Safe URLs</h2>
      <p id="safeCount">{{ safe_count }}</p>
    </div>
    <div class="card risky">
      <h2>Risky URLs</h2>
      <p id="riskyCount">{{ risky_count }}</p>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts">
    <div class="chart-card">
      <h2>Risk Distribution</h2>
      <canvas id="pieChart"></canvas>
    </div>
    <div class="chart-card">
      <h2>Recent Risk Scores</h2>
      <canvas id="barChart"></canvas>
    </div>
  </div>

  <!-- Recent Scans Table -->
  <div class="table-container glass">
    <h2>Recent Scan History</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>URL</th>
          <th>Result</th>
          <th>Score</th>
          <th>Timestamp</th>
          <th>Report</th>
        </tr>
      </thead>
      <tbody>
        {% for s in recent %}
        <tr class="{{ 'risky' if s.result == 'risky' else 'safe' }}">
          <td>{{ loop.index }}</td>
          <td class="url">{{ s.url }}</td>
          <td class="status {{ s.result }}">{{ s.result|upper }}</td>
          <td class="score">
            <span class="score-pill {{ 'high' if s.score > 0.7 else 'medium' if s.score > 0.3 else 'low' }}">
              {{ '%.3f'|format(s.score) }}
            </span>
          </td>
          <td>{{ s.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
          <td>
            <a href="{{ url_for('report_view', scan_id=s._id|string) }}" class="btn-view">View</a>
            <a href="{{ url_for('report_download', scan_id=s._id|string) }}" class="btn-pdf">PDF</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Styles -->
<style>
body {
  background: radial-gradient(circle at top left, #0f172a, #010409);
  font-family: 'Poppins', sans-serif;
  color: #f1f5f9;
  overflow-x: hidden;
}

.dashboard-container {
  padding: 2rem;
  min-height: 100vh;
  animation: fadeIn 1s ease;
}

/* Title */
.title {
  text-align: center;
  font-size: 2.4rem;
  font-weight: 700;
  margin-bottom: 3rem;
  background: linear-gradient(to right, #22d3ee, #60a5fa, #818cf8);
  -webkit-background-clip: text;
  color: transparent;
  letter-spacing: 0.5px;
  position: relative;
}
.title::after {
  content: "";
  position: absolute;
  width: 80px;
  height: 3px;
  background: linear-gradient(90deg, #22d3ee, #818cf8);
  left: 50%;
  bottom: -10px;
  transform: translateX(-50%);
  border-radius: 6px;
}

/* Statistic Cards */
.cards {
  display: flex;
  justify-content: center;
  gap: 2rem;
  flex-wrap: wrap;
  margin-bottom: 3rem;
}

.card {
  flex: 1 1 220px;
  max-width: 280px;
  padding: 1.8rem;
  text-align: center;
  border-radius: 16px;
  backdrop-filter: blur(14px);
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 0 25px rgba(0,0,0,0.4);
  background: rgba(255,255,255,0.03);
  transition: all 0.4s ease;
  position: relative;
  overflow: hidden;
}
.card::before {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at top left, rgba(56,189,248,0.15), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
}
.card:hover::before { opacity: 1; }
.card:hover {
  transform: translateY(-6px) scale(1.03);
  box-shadow: 0 0 25px rgba(56,189,248,0.25);
}

.card h2 {
  font-size: 1.1rem;
  color: #cbd5e1;
  margin-bottom: 0.8rem;
}
.card p {
  font-size: 2rem;
  font-weight: 700;
}
.card.total p { color: #60a5fa; }
.card.safe p { color: #22c55e; }
.card.risky p { color: #ef4444; }

/* Charts */
.charts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 2rem;
  margin-bottom: 3rem;
}
.chart-card {
  background: rgba(255,255,255,0.05);
  border-radius: 16px;
  padding: 1.5rem;
  text-align: center;
  box-shadow: 0 0 25px rgba(0,0,0,0.4);
  transition: transform 0.4s ease;
}
.chart-card:hover { transform: scale(1.03); }
.chart-card h2 {
  color: #a5f3fc;
  font-weight: 600;
  margin-bottom: 1.2rem;
}

/* Table */
.table-container {
  background: rgba(255,255,255,0.05);
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: 0 0 30px rgba(0,0,0,0.4);
}
.table-container h2 {
  color: #38bdf8;
  margin-bottom: 1.5rem;
  text-align: center;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.95rem;
  color: #f8fafc;
}
thead {
  background: rgba(255,255,255,0.08);
  text-transform: uppercase;
}
th, td {
  padding: 0.9rem 1rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
tr:hover {
  background: rgba(56,189,248,0.08);
  transition: background 0.2s ease;
}
.url {
  max-width: 320px;
  word-break: break-word;
  color: #60a5fa;
}

/* Result colors */
td.safe { color: #22c55e; font-weight: 600; }
td.risky { color: #ef4444; font-weight: 600; }

/* Score color indicators */
.score-pill {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 0.85rem;
  color: #fff;
}
.score-pill.low {
  background: rgba(34,197,94,0.25);
  border: 1px solid #22c55e;
  box-shadow: 0 0 8px rgba(34,197,94,0.3);
}
.score-pill.medium {
  background: rgba(234,179,8,0.2);
  border: 1px solid #eab308;
  box-shadow: 0 0 8px rgba(234,179,8,0.3);
}
.score-pill.high {
  background: rgba(239,68,68,0.25);
  border: 1px solid #ef4444;
  box-shadow: 0 0 8px rgba(239,68,68,0.3);
}

/* Buttons */
.btn-view, .btn-pdf {
  display: inline-block;
  margin: 0 0.2rem;
  padding: 0.35rem 0.7rem;
  border-radius: 8px;
  font-size: 0.85rem;
  text-decoration: none;
  transition: all 0.3s ease;
}
.btn-view {
  background: rgba(56,189,248,0.15);
  color: #38bdf8;
}
.btn-view:hover {
  background: rgba(56,189,248,0.3);
}
.btn-pdf {
  background: rgba(239,68,68,0.15);
  color: #f87171;
}
.btn-pdf:hover {
  background: rgba(239,68,68,0.3);
}

/* Animation */
.fade-in {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeIn 0.8s ease forwards;
}
@keyframes fadeIn {
  to { opacity: 1; transform: translateY(0); }
}
</style>

<!-- Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const animateCounter = (id, endValue) => {
    const el = document.getElementById(id);
    let start = 0;
    const duration = 1200;
    const step = Math.ceil(endValue / 60);
    const interval = setInterval(() => {
      start += step;
      if (start >= endValue) { start = endValue; clearInterval(interval); }
      el.textContent = start.toLocaleString();
    }, duration / 60);
  };
  animateCounter("totalCount", {{ total }});
  animateCounter("safeCount", {{ safe_count }});
  animateCounter("riskyCount", {{ risky_count }});

  // Pie Chart
  const pieCtx = document.getElementById("pieChart").getContext("2d");
  const gradientSafe = pieCtx.createLinearGradient(0, 0, 0, 150);
  gradientSafe.addColorStop(0, "#22c55e");
  gradientSafe.addColorStop(1, "#16a34a");
  const gradientRisky = pieCtx.createLinearGradient(0, 0, 0, 150);
  gradientRisky.addColorStop(0, "#ef4444");
  gradientRisky.addColorStop(1, "#b91c1c");

  new Chart(pieCtx, {
    type: "doughnut",
    data: {
      labels: ["Safe", "Risky"],
      datasets: [{
        data: [{{ safe_count }}, {{ risky_count }}],
        backgroundColor: [gradientSafe, gradientRisky],
        borderWidth: 0
      }]
    },
    options: {
      cutout: "70%",
      plugins: {
        legend: {
          position: "bottom",
          labels: { color: "#f1f5f9", font: { size: 13 } }
        }
      }
    }
  });

  // Bar Chart
  const barCtx = document.getElementById("barChart").getContext("2d");
  new Chart(barCtx, {
    type: "bar",
    data: {
      labels: [{% for s in recent %}"{{ s.url.split('//')[-1][:15] }}",{% endfor %}],
      datasets: [{
        label: "Risk Score",
        data: [{% for s in recent %}{{ "%.3f"|format(s.score) }},{% endfor %}],
        backgroundColor: "#38bdf8",
        borderRadius: 8,
      }]
    },
    options: {
      scales: {
        x: { ticks: { color: "#a1a1aa", font: { size: 11 } } },
        y: { ticks: { color: "#a1a1aa", font: { size: 11 } }, beginAtZero: true, max: 1 }
      },
      plugins: {
        legend: { labels: { color: "#fff" } },
        tooltip: { backgroundColor: "#1e293b", titleColor: "#38bdf8", bodyColor: "#f1f5f9" }
      }
    }
  });
});
</script>
{% endblock %}
